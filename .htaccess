# Main .htaccess file for the bank
# Copyright 2019 - Ethan Marshall

# Make sure uppercase directory index is supported
DirectoryIndex Index.php

# Turn on rewrite engine
RewriteEngine on

# Pretty permalinks support
RewriteBase /
RewriteRule ^Index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /Index.php?permalink=1 [L]

# Deny access to certain areas
<Files ~ "\.ini$">
Order Allow,Deny
Deny from All
</Files>

<Files ~ "\.json$">
Order Allow,Deny
Deny from All
</Files>

<Files ~ "setuptoken.txt$">
Order Allow,Deny
Deny from All
</Files>

# Force output buffering (fixes header errors)
php_value output_buffering 4096

# Custom error pages
ErrorDocument 400 /error/Error.php?code=400
ErrorDocument 401 /error/Error.php?code=401
ErrorDocument 403 /error/Error.php?code=403
ErrorDocument 404 /error/Error.php?code=404
ErrorDocument 500 /error/Error.php?code=500

RewriteEngine On
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteCond %{HTTPS} off
RewriteCond %{HTTP:CF-Visitor} !{"scheme":"https"}
RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
